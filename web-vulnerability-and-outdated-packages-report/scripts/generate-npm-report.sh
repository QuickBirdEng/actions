#!/bin/bash

for arg in "$@"; do
  case $arg in
    --module=*)
      module="${arg#*=}"
      ;;
    --project-path=*)
      project_path="${arg#*=}"
      ;;
    --reports-path=*)
      reports_path="${arg#*=}"
      ;;
    *)
      echo "Unknown argument: $arg"
      usage
      ;;
  esac
done

cd $project_path/$module

npm install

if [ $module == "." ]; then
  module="root"
fi

output_file="${reports_path}/npm-report_${module}.csv"

echo "Library,Current Version,Latest Version,Severity,Direct Impact,Fix Available, Detail" > $output_file

# Get the vulnerabilities data from npm audit (only run once)
vulnerabilities=$(npm audit --json | jq '.vulnerabilities')

outdated=$(npm outdated --no-color --json)

for package in $(echo "$vulnerabilities" | jq -r 'keys[]'); do
    vulnerability=$(echo "$vulnerabilities" | jq -r ".[\"$package\"]")

    current=$(echo "$outdated" | jq -r ".[\"$package\"].current")
    latest=$(echo "$outdated" | jq -r ".[\"$package\"].latest")

    if [ "$current" == "null" ]; then
        current=""
        latest=""
    fi

    is_direct=$(echo "$vulnerability" | jq -r '.isDirect')
    severity=$(echo "$vulnerability" | jq -r '.severity')
    fix_available=$(echo "$vulnerability" | jq -r '.fixAvailable | if type == "object" then true else . end')
    url=$(echo "$vulnerability" | jq -r '.via[0] | if type == "object" then .url else "" end')

    echo "\"$package\",\"$current\",\"$latest\",\"$severity\",\"$is_direct\",\"$fix_available\", $url" >> "${output_file}"
done

for package in $(echo "$outdated" | jq -r 'keys[]'); do
  current=$(echo "$outdated" | jq -r ".[\"$package\"].current")
  latest=$(echo "$outdated" | jq -r ".[\"$package\"].latest")

  vulnerability=$(echo "$vulnerabilities" | jq -r ".[\"$package\"]")

  if [ "$vulnerability" == "null" ]; then
    echo "\"$package\",\"$current\",\"$latest\",,," >> $output_file
  fi
done
