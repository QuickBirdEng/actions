#!/bin/bash

usage() {
  echo "Usage: $0 --project-path <path> --reports-path <reports-path>"
  exit 1
}

calculate_cvss_base_score() {
    local vector=$1
    bash cvss-3-1-severity.sh --vector=$vector
}

for arg in "$@"; do
  case $arg in
    --project-path=*)
      project_path="${arg#*=}"
      ;;
    --reports-path=*)
      reports_path="${arg#*=}"
      ;;
    *)
      echo "Unknown argument: $arg"
      usage
      ;;
  esac
done

mkdir -p $reports_path
cd $project_path

output_file="${reports_path}/flutter-report.csv"
audit_log_file="${reports_path}/flutter-report_audit.log"
outdated_log_file="${reports_path}/flutter-report_outdated.log"

echo "Library,Type,Current Version,Latest/Fixed Version,Kind,Severity, Detail" > $output_file

osv-scanner scan > $audit_log_file
flutter pub outdated > $outdated_log_file

result=$(osv-scanner scan --json .)

result=$(echo "$result" | jq -r '.results[].packages[] |
  {
    (.package.name): {
      "version": .package.version,
      "ecosystem": .package.ecosystem,
      "vulnerabilities": (
        .vulnerabilities | map({
          "id": .id,
          "severity_score": (.severity[0].score),
          "fixed_version": (
            .affected[]?.ranges[]?.events[] | select(.fixed) | .fixed // "Not Fixed"
          ),
        })
      )
    }
  }' | jq -s 'add')

keys=$(echo "$result" | jq -r 'keys[]')

for package_name in $keys; do
    package=$(echo "$result" | jq -r ".[\"$package_name\"]")
    echo $package_name
    version=$(echo "$package" | jq -r '.version')
    ecosystem=$(echo "$package" | jq -r '.ecosystem')
    vulnerabilities=$(echo "$package" | jq -r '.vulnerabilities')

    echo "$vulnerabilities" | jq -c '.[]' | while read -r vulnerability; do
       id=$(echo "$vulnerability" | jq -r '.id')
       fixed_version=$(echo "$vulnerability" | jq -r '.fixed_version')
       severity_score=$(echo "$vulnerability" | jq -r '.severity_score')
       severity=$(calculate_cvss_base_score $severity_score)

        echo "$package_name,$ecosystem,$version,$fixed_version,,$severity, $id" >> $output_file
    done
done

result=$(flutter pub outdated --no-dev-dependencies --json | jq '.packages | map({(.package): del(.package)}) | add')

for package in $(echo "$result" | jq -r 'keys[]'); do
  package_json=$(echo "$result" | jq -r ".[\"$package\"]")

  kind=$(echo "$package_json" | jq -r '.kind')
  is_discontinued=$(echo "$package_json" | jq -r '.isDiscontinued')
  current_version=$(echo "$package_json" | jq -r '.current.version')
  latest_version=$(echo "$package_json" | jq -r '.latest.version')

  # [[ $kind == "direct" ]] && is_direct="Yes" || is_direct="No"

  echo "$package,Pub,$current_version,$latest_version,$kind" >> $output_file
done
